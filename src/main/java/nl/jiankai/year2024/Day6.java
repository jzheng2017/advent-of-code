package nl.jiankai.year2024;

import java.util.*;
import java.util.stream.Collectors;

public class Day6 {
    public static void main(String[] args) {
        part2();
    }

    private static void part1() {
        List<List<String>> grid = grid();
        System.out.println(computeVisitedPositions(grid, false).size());
    }

    private static void part2() {
        List<List<String>> grid = grid();
        Pos guardPos = getGuardPos(grid);

        List<Pos> visited = new LinkedList<>(computeVisitedPositions(grid, false));

        visited.remove(guardPos);
        Set<Pos> loop = new HashSet<>();
        while (!visited.isEmpty()) {
            Pos pos = visited.get(0);
            visited.remove(0);
            grid = grid();
            if (pos.y != guardPos.y || pos.x != guardPos.x) {
                grid.get(pos.y).set(pos.x, "#");
            }
            try {
                computeVisitedPositions(grid, true);
            } catch (IllegalStateException e) {
                loop.add(new Pos(pos.x, pos.y, "#"));
            }
        }
        System.out.println(loop.size());
    }


    private static Set<Pos> computeVisitedPositions(List<List<String>> grid, boolean checkForLoop) {
        Pos pos = getGuardPos(grid);
        String guard = grid.get(pos.y).get(pos.x);
        int oldY = pos.y;
        int oldX = pos.x;
        int currY = pos.y;
        int currX = pos.x;
        int width = grid.get(0).size();
        Set<Pos> visited = new HashSet<>();
        int dup = 0;
        while (currX > 0 && currX < width - 1 && currY > 0 && currY < grid.size() - 1) {
            if (guard.equals("^")) {
                if (grid.get(--currY).get(currX).equals("#")) {
                    grid.get(oldY).set(oldX, ".");
                    grid.get(++currY).set(currX, ">");
                    guard = ">";
                    oldX = currX;
                    oldY = currY;
                }
            } else if (guard.equals(">")) {
                if (grid.get(currY).get(++currX).equals("#")) {
                    grid.get(oldY).set(oldX, ".");
                    grid.get(currY).set(--currX, ">");
                    guard = "v";
                    oldX = currX;
                    oldY = currY;
                }
            } else if (guard.equals("v")) {
                if (grid.get(++currY).get(currX).equals("#")) {
                    grid.get(oldY).set(oldX, ".");
                    grid.get(--currY).set(currX, "<");
                    guard = "<";
                    oldX = currX;
                    oldY = currY;
                }
            } else if (guard.equals("<")) {
                if (grid.get(currY).get(--currX).equals("#")) {
                    grid.get(oldY).set(oldX, ".");
                    grid.get(currY).set(++currX, "^");
                    guard = "^";
                    oldX = currX;
                    oldY = currY;
                }
            }
            if (!visited.add(new Pos(currX, currY, guard)) && checkForLoop) {
                dup++;
                if (dup >= visited.size()) {
                    throw new IllegalStateException();
                }
            } else {
                dup = 0;
            }
        }

        return visited;
    }

    private static List<List<String>> grid() {
        String[] lines = input.split("\n");
        List<List<String>> grid = new ArrayList<>();
        for (String line : lines) {
            grid.add(Arrays.stream(line.split("")).collect(Collectors.toList()));
        }

        return grid;
    }

    private static Pos getGuardPos(List<List<String>> lines) {
        for (int i = 0; i < lines.size(); i++) {
            for (int j = 0; j < lines.get(i).size(); j++) {
                if (lines.get(i).get(j).equals("^")) {
                    return new Pos(j, i, "^");
                }
            }
        }

        throw new RuntimeException("not found");
    }

    private record Pos(int x, int y, String val) {
    }


    private static String input = """
.......#.........#..............#........................#......#....#............................#..#...............#............
...................#.............................................#...................................#............................
...............#.................................##.........#..........#.....##...#...#.....#....#..................#.............
#.............................................#..#.............#..........#.##.............................................#......
#.........................................................#.....#........................................##.......................
...........#.......#.#...........#....#.#...#......................................#...........................#...##............#
........................................................#..#.....................................#..#................#....#...#...
#.#.....#.........................#...........#.......................................#.......#.....................##............
.......#..........##.....#........#..................................................#.........................................#.#
#.#..............#.#.............................#............#....#...............#.........................#............#..#.#.#
..........................................................#....................................................#..................
.......................#....#...........#.....................#....#...#.......#..............#.......................#...........
..............................#..............#.......#....................................#.....................#...#...#.........
........#.................#...#....##..............#...........................#............................#.................#...
..................#........................................#......#......................................................#........
.............#.................#...#..............................................................................#...#...........
.....................................#..........................................................#.#.#......#.........#............
..........#...................................................................#.........##.......#..#.............................
...#.#....................................#..#...........#.......................................................##...............
........................................................................................................#.........................
.........#...........#......#..............#........#....................#...#......#.............................................
........#....#...............#....................#..........#.....................................#......#......#........#.#.....
........................#..........................#.......#........................#................#......#.....................
......................................#.........................................#............................#....................
...................................#.#...#...........#.........................................#.....................#............
.................#....#.....................................................................#..................#.........#........
...........#...........................................................#.............................#...............#..#.........
..#.....................#.........................................................................................................
....................#....#.#...........................#...........................................#..............#...............
...#...................................................#.............................................#.........#..........#.......
.............................###.....#..#..#......................................................................................
##................#.#.......#..............#.....#...............#..#............#................................................
......#...............................................#.#..#............................#............#.................#..........
........................................#.#...................................................#.....#.............................
#.......#.#.......................#.....#....................................#...................#................................
...##................................................................................................#.....................#......
............#.............#..................#.................#..................................................................
...#..............#..............................................................................#..........#......#..............
...#..#...#................................................#.....................#......#......................#.......#..........
.................#..#........#...............#.#................#......##.................#.................................#.....
#.....#.......#...........................................#..........#..............................#...#.#..#......#.....#.......
....................................#.........#........#..................#.............................................#.........
#...............................#........................#.................................................#.....#................
..#..................................#.......#.....................#..............................................................
........#...#.....................................#......#..............#..#..#..........................#.#....#.................
.............#..........#....#................#.......#..........................................#.....#..........................
.............................................#................................#.........................#...#.....................
.........#........#...................................................................#.......#....#..............................
....................................#.......................#..............#...............................#......................
....#....................#................................#....#...........#.............#........................................
....#...........#...................#.#..................................................#.....................#..................
..........#....................#............#.##...#.......#....#...............#.....#...#.........................#.............
.......#....................................................................................................#.................#...
...............................................................................#......#.................#...#.....................
..................#........#..........#..........................................................................#................
..........................................................................................#.......................................
.#..#...........#.................................##...........................#.....#...................#..#.....................
........................#..#..........................................................#............#..................#..........#
...........#...................................................##...........................#...............................#.....
........#......................................................................................................#..................
........#..#............................#..#...........#..............................#......................#.##...........#....#
........#...#.#..............#...#.....................#....................#.#..............................#....................
.......................................................#....................................................#..#..................
...........................................#......................#................#........................#....................#
.............#...............#................................................................................#...................
..#...#............#.............#.....#........................#............#....................#...............................
.....#...................................................................................................................#........
....................#..#...........#....#.............................................................................#.......#...
..............#......#.........................#...........#...#...........................................#...#..................
..............................#.....#.........................................................#......#.#......#...................
............................................................#...................#.#............................#..................
.............###.#........................................#........................................................#..............
......#................................#...............##.........................................................................
.........#.....#.#.....................#.......................................#...............#..........#....#....#.............
..............................................#....................................#...........................................#..
............#.#..........#........#..#.....#.............#..........#............#......#...................##..........#.........
............#....#...................................#.............................#.........................#....................
.#..................................#....#.........................................................................#..............
.........................#...#...#.................#..................#.............#.#...#...............#.......................
.........#...............................#...........#.............................#...........................#..........#.......
......#..........................#.............#..........#.......................................................................
.......#...............#.........#.............#...............................#..................................................
..#......#....................##...........................................#........................................#.............
..........................#.....#.......................#...........................................................#.#...........
..#....................#.............#................................................................#.#.........................
.........#....................#.....#....#...............#.......................#........#.......................................
..............#...................................................................#................#...#..........................
....................#.....#.......#..#......................................#...........#..................................##....#
.......#.......................................................................#..................................................
......#.............##..........................#..#......................^.......................................................
..............................#..........#...................#.................................#.....................#............
.......................##..........................#.......#..............................#...................................#.#.
................#....................................................................#...............................#.........#..
..........................................#......#.....................................#................#........#................
#......................................#.......................................................#..#...........#...................
.......#.............#..................#..#...#............#.......#.....#.....#.#...............................................
.............................#........#.............#.....#.......#...................................#.#..................#......
.................#......................................................................................#........#..#.............
........................................................................#..............#.....#..............................#.....
....#....#..........................................#......##...#....................#...................#..........#.............
.................##.......................##.#.........#................................................#.........................
.#..............................................#.........................#.#.#..........#.....................................##.
............................................................#..........#....#...................................................#.
....#...........#.............................#.....................#.........#..................#...........................#....
......#.#.......#..#......#........#..#...................#....#..................................................................
............#........................................................................................................#............
.....................................................#..........................................#................#................
...#.......#..#..............#.............................#....................................#.................................
.................##.........#........................#....................................#...............#.#.#...................
................#......#......................#..#..........................................#.....................................
......#..................................................##.#.#........#...........................#.......................#......
........................#............#......#.........#.............#.............................................#.....#.##......
......................#........................................#.......#.........#.................#..#...........#...............
..#.......#.........##..#.#................................................................................#.........#............
........................................................................................#............#...........#................
................#...#....................#..##..#...............#.............................................................#...
...#........#..........................#.....#..........................#....................................#.........#.......##.
.................#...........................#.........#......#............................#.....................#................
...................#..........#....#.......#...................#.............................#..........#.........................
.......#..............#.................................#.........#....................................#.................#....##.#
..................................#.......................#....#..#.........................#....................#................
.....#.........#............#...#.........#........#...................#...#......................#.....#............#............
#.#....#...#........#................................##..........................#.............................##...#....#........
.............##..........##...#......#.......#.#................#.#.......................#.............#.........................
.............#....................................#....................................#..........................................
..................................#..............................#.......................................#................#.......
...................#...............#..............................................................................................
....#........#.................................#........#.....................................#.......#................#........#.
.................#......#.......................................................##.....#..................#.......................
...............#.......................#.#........#...........................................#........#..........................""";
}
